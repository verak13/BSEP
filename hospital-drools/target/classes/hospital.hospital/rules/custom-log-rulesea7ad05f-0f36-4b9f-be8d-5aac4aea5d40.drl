package hospital.hospital.rules;
import hospital.hospital.model.cep.LogEvent;
import hospital.hospital.services.MailService;
import hospital.hospital.model.cep.alarms.CustomLogAlarm;
import java.util.Date;
global MailService mailService

rule "da li radi ako izaberem i narednog znaci login error pa login pa opet login errror_0"
no-loop true
    when
        $previous: LogEvent(log.getType() in ("LOGIN_ERROR"))
        $next: LogEvent(log.getType() in ("LOGIN_ERROR"), this != $previous)
        $l1 : LogEvent(
                log.getType() in ("LOGIN"),
                log.getSeverity().name() in ("WARN","INFO","ERROR","TRACE"),
                this != $previous,
                this != $next,
                this after[0, 9s] $previous,
                $next after[0, 20s] this
                )
        $appearance: Long(intValue >= 0) from accumulate(
                                    $l2: LogEvent(
                                        this != $l1,
                                        log.getType() in ("LOGIN"),
                                        log.getSeverity().name() in ("WARN","INFO","ERROR","TRACE")
                                    )
                                    over window:time(0s),
                                    count($l2)
                                )
               not (CustomLogAlarm(ruleName == "da li radi ako izaberem i narednog znaci login error pa login pa opet login errror"))
    then
       System.out.println("\n\n==== TRIGEROVAN CUSTOM LOG ALARM  ===");
       System.out.println("RULE NAME: " + "da li radi ako izaberem i narednog znaci login error pa login pa opet login errror");
       insert(new CustomLogAlarm($l1.getLog().getTimestamp(), "ovo ce biti cupavoo", "da li radi ako izaberem i narednog znaci login error pa login pa opet login errror"));
end
rule "Custom log alarm triggered, notify admin by email_da li radi ako izaberem i narednog znaci login error pa login pa opet login errror_"
no-loop true
  when
        $alarm : CustomLogAlarm($message: errorMsg, $date: date, sentEmail == false)
    then
        System.out.println("\n\nSENDING EMAIL...");
        String msg = "Custom log alarm triggered on date : " + $date + ". Alarm message: " + $message + ".Rule name: " + $alarm.getRuleName();
        mailService.notifyAdmin($alarm.getAdminEmail(), msg);
        modify($alarm) { setSentEmail(true); }
end


